<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapas QGIS - Filtro M√∫ltiple</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: Arial, sans-serif; }
        #map { height:100vh; width:100%; }
        #panel {
            position:absolute; top:10px; left:10px;
            background:white; padding:15px; border-radius:8px;
            box-shadow:0 3px 15px rgba(0,0,0,0.2); z-index:1000;
            width:350px;
            border:1px solid #ddd;
        }
        .capa-item {
            margin-bottom:15px; padding:12px;
            background:#f8f9fa; border-radius:6px;
            border-left:4px solid #3498db;
        }
        .capa-header {
            display:flex; align-items:center; margin-bottom:10px;
        }
        .capa-title {
            flex:1; font-weight:bold; font-size:14px;
        }
        .capa-count {
            background:#3498db; color:white;
            padding:2px 8px; border-radius:10px;
            font-size:11px;
        }
        
        /* Filtro m√∫ltiple */
        .filtro-container {
            margin-top:10px;
        }
        .input-label {
            font-size:12px; color:#555; margin-bottom:5px;
            display:block;
        }
        .multi-search {
            width:100%; padding:8px; margin-bottom:8px;
            border:1px solid #ccc; border-radius:4px;
            font-size:13px;
        }
        .multi-search:focus {
            outline:none; border-color:#3498db;
            box-shadow:0 0 0 2px rgba(52,152,219,0.2);
        }
        .hint {
            font-size:11px; color:#666; margin:5px 0;
            font-style:italic;
        }
        .examples {
            font-size:11px; color:#777; margin:5px 0;
            background:#f0f0f0; padding:5px; border-radius:3px;
        }
        
        /* Botones */
        .btn-group {
            display:flex; gap:8px; margin-top:10px;
        }
        .btn {
            flex:1; padding:8px; border:none;
            border-radius:4px; cursor:pointer;
            font-size:12px; font-weight:500;
        }
        .btn-filtrar { background:#27ae60; color:white; }
        .btn-filtrar:hover { background:#219653; }
        .btn-limpiar { background:#e74c3c; color:white; }
        .btn-limpiar:hover { background:#c0392b; }
        
        /* Loading */
        #loading {
            position:fixed; top:0; left:0;
            width:100%; height:100%;
            background:white; z-index:9999;
            display:flex; flex-direction:column;
            justify-content:center; align-items:center;
        }
        .spinner {
            width:40px; height:40px;
            border:3px solid #f3f3f3;
            border-top:3px solid #3498db;
            border-radius:50%; animation:spin 1s linear infinite;
        }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        #loading.hidden {
            display:none;
        }
        
        /* Resultados */
        .results {
            font-size:11px; margin-top:5px;
            padding:5px; background:#e8f4fc;
            border-radius:4px; display:none;
        }
        
        /* Checkbox toggle */
        .toggle {
            display:flex; align-items:center; gap:8px;
            margin-bottom:8px; cursor:pointer;
        }
        .toggle input[type="checkbox"] {
            margin:0;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Panel de control -->
    <div id="panel">
        <h3 style="margin-bottom:15px; color:#2c3e50;">
            üó∫Ô∏è Filtro M√∫ltiple por Oficinas
        </h3>
        
        <div id="capas-container">

            <div class="capa-item">
                <div class="capa-header">
                    <div class="capa-title">
                        Oficina
                    </div>
                    <div class="capa-count">
                        64
                    </div>
                </div>
                
                <div class="toggle">
                    <input type="checkbox" id="toggle-0" checked>
                    <label for="toggle-0">Mostrar capa</label>
                </div>
                
                <div class="filtro-container">
                    <label class="input-label">
                        üîç Filtrar por oficinas (separar con comas):
                    </label>
                    <input type="text" class="multi-search" id="search-0" 
                           placeholder="Ej: OFICINA_ACP">
                    
                    <div class="hint">
                        üí° Puedes filtrar por varias oficinas: "trujillo, otuzco, huamachuco"
                    </div>
                    
                    <div class="examples">
                        <strong>Ejemplos disponibles:</strong><br>
                        OFICINA_ACP, CHOTA, AYACUCHO, TINGO MARIA, CASMA, PAMPAS, NAZCA, HUANCAYO, DM MINKA, ATE
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-filtrar" onclick="aplicarFiltro(0)" 
                                id="btn-filtrar-0">
                            ‚úÖ Aplicar Filtro
                        </button>
                        <button class="btn btn-limpiar" onclick="limpiarFiltro(0)" 
                                id="btn-limpiar-0" style="display:none;">
                            ‚úï Limpiar
                        </button>
                    </div>
                    
                    <div class="results" id="results-0">
                        <!-- Resultados aparecen aqu√≠ -->
                    </div>
                </div>
            </div>

            <div class="capa-item">
                <div class="capa-header">
                    <div class="capa-title">
                        Zonas
                    </div>
                    <div class="capa-count">
                        280
                    </div>
                </div>
                
                <div class="toggle">
                    <input type="checkbox" id="toggle-1" checked>
                    <label for="toggle-1">Mostrar capa</label>
                </div>
                
                <div class="filtro-container">
                    <label class="input-label">
                        üîç Filtrar por oficinas (separar con comas):
                    </label>
                    <input type="text" class="multi-search" id="search-1" 
                           placeholder="Ej: CHOTA">
                    
                    <div class="hint">
                        üí° Puedes filtrar por varias oficinas: "trujillo, otuzco, huamachuco"
                    </div>
                    
                    <div class="examples">
                        <strong>Ejemplos disponibles:</strong><br>
                        CHOTA, AYACUCHO, TINGO MARIA, CASMA, PAMPAS, NAZCA, HUANCAYO, DM MINKA, ATE, LAMBAYEQUE
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-filtrar" onclick="aplicarFiltro(1)" 
                                id="btn-filtrar-1">
                            ‚úÖ Aplicar Filtro
                        </button>
                        <button class="btn btn-limpiar" onclick="limpiarFiltro(1)" 
                                id="btn-limpiar-1" style="display:none;">
                            ‚úï Limpiar
                        </button>
                    </div>
                    
                    <div class="results" id="results-1">
                        <!-- Resultados aparecen aqu√≠ -->
                    </div>
                </div>
            </div>

            <div class="capa-item">
                <div class="capa-header">
                    <div class="capa-title">
                        Territorio
                    </div>
                    <div class="capa-count">
                        320
                    </div>
                </div>
                
                <div class="toggle">
                    <input type="checkbox" id="toggle-2" checked>
                    <label for="toggle-2">Mostrar capa</label>
                </div>
                
                <div class="filtro-container">
                    <label class="input-label">
                        üîç Filtrar por oficinas (separar con comas):
                    </label>
                    <input type="text" class="multi-search" id="search-2" 
                           placeholder="Ej: CAMANA">
                    
                    <div class="hint">
                        üí° Puedes filtrar por varias oficinas: "trujillo, otuzco, huamachuco"
                    </div>
                    
                    <div class="examples">
                        <strong>Ejemplos disponibles:</strong><br>
                        CAMANA, HUARI, CHOTA, AYACUCHO, TINGO MARIA, CASMA, CHANCHAMAYO, NAZCA, HUANCAYO, PAMPAS
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-filtrar" onclick="aplicarFiltro(2)" 
                                id="btn-filtrar-2">
                            ‚úÖ Aplicar Filtro
                        </button>
                        <button class="btn btn-limpiar" onclick="limpiarFiltro(2)" 
                                id="btn-limpiar-2" style="display:none;">
                            ‚úï Limpiar
                        </button>
                    </div>
                    
                    <div class="results" id="results-2">
                        <!-- Resultados aparecen aqu√≠ -->
                    </div>
                </div>
            </div>

        </div>
        
        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee; font-size:11px; color:#666;">
            <p><strong>üéØ Instrucciones:</strong></p>
            <p>1. Escribe oficinas separadas por comas</p>
            <p>2. Puedes usar "trujillo, otuzco, huamachuco"</p>
            <p>3. El filtro es CASE INSENSITIVE (no distingue may√∫sculas/min√∫sculas)</p>
        </div>
    </div>
    
    <!-- Loading -->
    <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-size:14px;">Cargando mapas...</p>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const capasConfig = [
  {
    "nombre": "Oficina",
    "archivo": "oficina.geojson",
    "elementos": 64,
    "color_normal": "#FF0000",
    "color_filtrado": "#FF6B6B",
    "ejemplos": [
      "OFICINA_ACP",
      "CHOTA",
      "AYACUCHO",
      "TINGO MARIA",
      "CASMA",
      "PAMPAS",
      "NAZCA",
      "HUANCAYO",
      "DM MINKA",
      "ATE"
    ]
  },
  {
    "nombre": "Zonas",
    "archivo": "zonas.geojson",
    "elementos": 280,
    "color_normal": "#00FF00",
    "color_filtrado": "#00CC00",
    "ejemplos": [
      "CHOTA",
      "AYACUCHO",
      "TINGO MARIA",
      "CASMA",
      "PAMPAS",
      "NAZCA",
      "HUANCAYO",
      "DM MINKA",
      "ATE",
      "LAMBAYEQUE"
    ]
  },
  {
    "nombre": "Territorio",
    "archivo": "territorio.geojson",
    "elementos": 320,
    "color_normal": "#0000FF",
    "color_filtrado": "#0066CC",
    "ejemplos": [
      "CAMANA",
      "HUARI",
      "CHOTA",
      "AYACUCHO",
      "TINGO MARIA",
      "CASMA",
      "CHANCHAMAYO",
      "NAZCA",
      "HUANCAYO",
      "PAMPAS"
    ]
  }
];
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let mapa;
        const capasLeaflet = {};
        const datosOriginales = {};
        let filtrosActivos = {};
        
        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        
        // Normalizar texto (quitar acentos, min√∫sculas)
        function normalizarTexto(texto) {
            return texto
                .toLowerCase()
                .normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "") // Quitar acentos
                .trim();
        }
        
        // Separar y limpiar t√©rminos de b√∫squeda
        function parsearTerminosBusqueda(texto) {
            if (!texto) return [];
            
            return texto
                .split(',')  // Separar por comas
                .map(term => normalizarTexto(term))
                .filter(term => term.length > 0); // Quitar t√©rminos vac√≠os
        }
        
        // Verificar si un feature coincide con los t√©rminos
        function featureCoincide(feature, terminos) {
            if (!feature.properties || terminos.length === 0) return false;
            
            // Buscar en todos los campos que puedan contener "OFICINA"
            for (let campo in feature.properties) {
                if (campo.toUpperCase().includes('OFICINA')) {
                    const valor = feature.properties[campo];
                    if (valor) {
                        const valorNormalizado = normalizarTexto(String(valor));
                        
                        // Verificar si coincide con ALGUNO de los t√©rminos
                        for (let termino of terminos) {
                            if (valorNormalizado.includes(termino)) {
                                return true;
                            }
                        }
                    }
                }
            }
            return false;
        }
        
        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        // Inicializar mapa
        async function inicializar() {
            console.log("üöÄ Iniciando sistema de filtro m√∫ltiple...");
            
            // Crear mapa
            mapa = L.map('map').setView([-12.0, -77.0], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(mapa);
            
            // Inicializar filtros
            capasConfig.forEach((_, i) => {
                filtrosActivos[i] = {
                    activo: false,
                    terminos: [],
                    resultados: 0
                };
            });
            
            // Cargar capas en paralelo
            const promesas = capasConfig.map((capa, i) => cargarCapa(i));
            await Promise.all(promesas);
            
            // Ocultar loading
            document.getElementById('loading').classList.add('hidden');
            
            // Ajustar vista inicial
            ajustarVistaGlobal();
            
            console.log("‚úÖ Sistema listo");
        }
        
        // Cargar una capa
        async function cargarCapa(index) {
            const capa = capasConfig[index];
            
            try {
                // Cargar datos
                const respuesta = await fetch('data/' + capa.archivo);
                const datos = await response.json();
                
                // Guardar original
                datosOriginales[index] = datos;
                
                // Crear capa Leaflet
                capasLeaflet[index] = L.geoJSON(datos, {
                    style: {
                        color: capa.color_normal,
                        fillColor: capa.color_normal,
                        fillOpacity: 0.4,
                        weight: 2
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            let contenido = `<div style="max-width:300px;">
                                <h4 style="color:${capa.color_normal};">${capa.nombre}</h4>`;
                            
                            // Resaltar campo OFICINA si existe
                            for (let campo in feature.properties) {
                                if (feature.properties[campo]) {
                                    const esOficina = campo.toUpperCase().includes('OFICINA');
                                    const estilo = esOficina ? 'color:#e74c3c; font-weight:bold;' : '';
                                    contenido += `<p style="${estilo}"><b>${campo}:</b> ${feature.properties[campo]}</p>`;
                                }
                            }
                            
                            contenido += '</div>';
                            layer.bindPopup(contenido);
                        }
                    }
                });
                
                // Agregar al mapa si est√° activa
                const checkbox = document.getElementById('toggle-' + index);
                if (checkbox.checked) {
                    capasLeaflet[index].addTo(mapa);
                }
                
                // Configurar evento del checkbox
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        mapa.addLayer(capasLeaflet[index]);
                    } else {
                        mapa.removeLayer(capasLeaflet[index]);
                    }
                });
                
                console.log(`‚úÖ ${capa.nombre} cargada: ${datos.features.length} elementos`);
                return true;
                
            } catch (error) {
                console.error(`‚ùå Error cargando ${capa.nombre}:`, error);
                return false;
            }
        }
        
        // Aplicar filtro m√∫ltiple
        function aplicarFiltro(index) {
            const input = document.getElementById('search-' + index);
            const textoBusqueda = input.value.trim();
            
            if (!textoBusqueda) {
                alert('‚ö†Ô∏è Por favor, escribe al menos una oficina para filtrar');
                return;
            }
            
            // Parsear t√©rminos
            const terminos = parsearTerminosBusqueda(textoBusqueda);
            console.log(`üîç Filtro capa ${index} (${capasConfig[index].nombre}):`, terminos);
            
            if (terminos.length === 0) {
                alert('‚ö†Ô∏è No se detectaron t√©rminos v√°lidos. Escribe algo como: "trujillo, otuzco"');
                return;
            }
            
            const datos = datosOriginales[index];
            if (!datos) {
                alert('‚ùå Los datos no est√°n cargados');
                return;
            }
            
            // Filtrar features
            const featuresFiltradas = datos.features.filter(feature => 
                featureCoincide(feature, terminos)
            );
            
            console.log(`üìä Resultados: ${featuresFiltradas.length} de ${datos.features.length}`);
            
            if (featuresFiltradas.length === 0) {
                alert(`‚ùå No se encontraron resultados para: "${textoBusqueda}"`);
                return;
            }
            
            // Crear datos filtrados
            const datosFiltrados = {
                type: 'FeatureCollection',
                features: featuresFiltradas
            };
            
            // Remover capa actual
            if (capasLeaflet[index]) {
                mapa.removeLayer(capasLeaflet[index]);
            }
            
            // Crear nueva capa filtrada
            capasLeaflet[index] = L.geoJSON(datosFiltrados, {
                style: {
                    color: capasConfig[index].color_filtrado,
                    fillColor: capasConfig[index].color_filtrado,
                    fillOpacity: 0.6,
                    weight: 3
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties) {
                        let contenido = `<div style="max-width:300px;">
                            <h4 style="color:${capasConfig[index].color_filtrado};">
                                ${capasConfig[index].nombre} (Filtrado)
                            </h4>`;
                        
                        // Mostrar t√©rminos encontrados
                        contenido += `<p style="color:#27ae60; font-weight:bold;">
                            üîç Filtrado por: ${terminos.join(', ')}
                        </p>`;
                        
                        for (let campo in feature.properties) {
                            if (feature.properties[campo]) {
                                const esOficina = campo.toUpperCase().includes('OFICINA');
                                const estilo = esOficina ? 'color:#e74c3c; font-weight:bold;' : '';
                                contenido += `<p style="${estilo}"><b>${campo}:</b> ${feature.properties[campo]}</p>`;
                            }
                        }
                        
                        contenido += '</div>';
                        layer.bindPopup(contenido);
                    }
                }
            });
            
            // Agregar al mapa si est√° activa
            const checkbox = document.getElementById('toggle-' + index);
            if (checkbox.checked) {
                capasLeaflet[index].addTo(mapa);
            }
            
            // Actualizar estado
            filtrosActivos[index] = {
                activo: true,
                terminos: terminos,
                resultados: featuresFiltradas.length
            };
            
            // Actualizar interfaz
            document.getElementById('btn-filtrar-' + index).style.display = 'none';
            document.getElementById('btn-limpiar-' + index).style.display = 'inline-block';
            
            // Mostrar resultados
            const resultadosDiv = document.getElementById('results-' + index);
            resultadosDiv.innerHTML = `
                <strong>‚úÖ Filtro aplicado:</strong><br>
                ‚Ä¢ T√©rminos: ${terminos.join(', ')}<br>
                ‚Ä¢ Resultados: ${featuresFiltradas.length} elementos<br>
                ‚Ä¢ Porcentaje: ${((featuresFiltradas.length / datos.features.length) * 100).toFixed(1)}%
            `;
            resultadosDiv.style.display = 'block';
            
            // Ajustar vista a los resultados
            ajustarVistaCapa(index);
            
            // Mostrar resumen
            alert(`‚úÖ Filtro aplicado a ${capasConfig[index].nombre}
` +
                  `üîç T√©rminos: ${terminos.join(', ')}
` +
                  `üìä Encontrados: ${featuresFiltradas.length} elementos`);
        }
        
        // Limpiar filtro
        function limpiarFiltro(index) {
            const input = document.getElementById('search-' + index);
            input.value = '';
            
            const datos = datosOriginales[index];
            if (!datos) return;
            
            // Remover capa actual
            if (capasLeaflet[index]) {
                mapa.removeLayer(capasLeaflet[index]);
            }
            
            // Restaurar capa original
            capasLeaflet[index] = L.geoJSON(datos, {
                style: {
                    color: capasConfig[index].color_normal,
                    fillColor: capasConfig[index].color_normal,
                    fillOpacity: 0.4,
                    weight: 2
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties) {
                        let contenido = `<div style="max-width:300px;">
                            <h4 style="color:${capasConfig[index].color_normal};">${capasConfig[index].nombre}</h4>`;
                        
                        for (let campo in feature.properties) {
                            if (feature.properties[campo]) {
                                const esOficina = campo.toUpperCase().includes('OFICINA');
                                const estilo = esOficina ? 'color:#e74c3c; font-weight:bold;' : '';
                                contenido += `<p style="${estilo}"><b>${campo}:</b> ${feature.properties[campo]}</p>`;
                            }
                        }
                        
                        contenido += '</div>';
                        layer.bindPopup(contenido);
                    }
                }
            });
            
            // Agregar al mapa si est√° activa
            const checkbox = document.getElementById('toggle-' + index);
            if (checkbox.checked) {
                capasLeaflet[index].addTo(mapa);
            }
            
            // Actualizar estado
            filtrosActivos[index] = {
                activo: false,
                terminos: [],
                resultados: 0
            };
            
            // Actualizar interfaz
            document.getElementById('btn-filtrar-' + index).style.display = 'inline-block';
            document.getElementById('btn-limpiar-' + index).style.display = 'none';
            
            // Ocultar resultados
            document.getElementById('results-' + index).style.display = 'none';
            
            // Ajustar vista global
            ajustarVistaGlobal();
            
            console.log(`üîÑ Filtro limpiado: ${capasConfig[index].nombre}`);
        }
        
        // Ajustar vista a todas las capas
        function ajustarVistaGlobal() {
            setTimeout(() => {
                let bounds = null;
                
                for (let i in capasLeaflet) {
                    const checkbox = document.getElementById('toggle-' + i);
                    if (checkbox && checkbox.checked && capasLeaflet[i].getBounds) {
                        if (!bounds) {
                            bounds = capasLeaflet[i].getBounds();
                        } else {
                            bounds.extend(capasLeaflet[i].getBounds());
                        }
                    }
                }
                
                if (bounds && bounds.isValid()) {
                    mapa.fitBounds(bounds, { padding: [30, 30] });
                }
            }, 300);
        }
        
        // Ajustar vista a una capa espec√≠fica
        function ajustarVistaCapa(index) {
            if (capasLeaflet[index] && capasLeaflet[index].getBounds) {
                const bounds = capasLeaflet[index].getBounds();
                if (bounds.isValid()) {
                    mapa.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', inicializar);
        
        // Funci√≥n para depuraci√≥n
        window.mostrarEstadoFiltros = function() {
            console.log("=== ESTADO DE FILTROS ===");
            for (let i in filtrosActivos) {
                const filtro = filtrosActivos[i];
                console.log(`Capa ${i} (${capasConfig[i].nombre}):`, 
                    filtro.activo ? `ACTIVO - ${filtro.terminos.join(', ')} (${filtro.resultados} resultados)` : 'INACTIVO');
            }
        };
        
    </script>
</body>
</html>