<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapas QGIS con Filtro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: Arial, sans-serif; }
        #map { height:100vh; width:100%; }
        #panel {
            position:absolute; top:20px; left:20px;
            background:white; padding:15px; border-radius:10px;
            box-shadow:0 4px 15px rgba(0,0,0,0.2); z-index:1000;
            width:320px;
        }
        .capa-item {
            margin:10px 0; padding:10px;
            background:#f5f5f5; border-radius:5px;
            border-left:4px solid #3498db;
        }
        .capa-item.filtrada {
            border-left:4px solid #e74c3c;
            background:#fff5f5;
        }
        .color-box {
            width:15px; height:15px;
            margin-right:10px; border-radius:3px;
            border:1px solid #ddd;
        }
        .filtro {
            margin-top:10px; padding-top:10px;
            border-top:1px solid #eee;
        }
        .search-box {
            width:100%; padding:8px; margin:5px 0;
            border:1px solid #ddd; border-radius:4px;
            font-size:14px;
        }
        .search-box:focus {
            outline:none;
            border-color:#3498db;
            box-shadow:0 0 0 2px rgba(52,152,219,0.2);
        }
        .btn {
            padding:8px 12px; margin:5px 5px 5px 0;
            background:#3498db; color:white;
            border:none; border-radius:4px; cursor:pointer;
            font-size:13px;
        }
        .btn-filtrar { background:#27ae60; }
        .btn-filtrar:hover { background:#219653; }
        .btn-limpiar { background:#e74c3c; }
        .btn-limpiar:hover { background:#c0392b; }
        #loading {
            position:fixed; top:50%; left:50%;
            transform:translate(-50%,-50%);
            background:white; padding:20px;
            border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2);
            z-index:9999;
            text-align:center;
        }
        .spinner {
            border:4px solid #f3f3f3;
            border-top:4px solid #3498db;
            border-radius:50%;
            width:40px; height:40px;
            animation:spin 1s linear infinite;
            margin:0 auto 15px;
        }
        @keyframes spin {
            0% { transform:rotate(0deg); }
            100% { transform:rotate(360deg); }
        }
        .estado-filtro {
            font-size:11px; padding:3px 8px;
            border-radius:10px; margin-left:10px;
            background:#eee; color:#666;
        }
        .estado-filtro.activo {
            background:#27ae60; color:white;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Panel de control -->
    <div id="panel">
        <h3 style="margin-bottom:15px; color:#2c3e50;">
            üó∫Ô∏è Mapas QGIS
        </h3>
        <div id="capas-container">

            <div class="capa-item" id="capa-item-0">
                <div style="display:flex; align-items:center; margin-bottom:8px;">
                    <div class="color-box" style="background:#FF0000" 
                         id="color-indicator-0"></div>
                    <label style="flex:1; cursor:pointer; font-weight:bold;">
                        <input type="checkbox" id="toggle-0" checked 
                               onchange="toggleCapa(0)">
                        Oficina
                    </label>
                    <span style="font-size:12px; color:#666; margin-left:10px;">
                        (64)
                    </span>
                    <span class="estado-filtro" id="estado-filtro-0">
                        normal
                    </span>
                </div>
                
                <div class="filtro">
                    <div style="font-size:12px; margin-bottom:5px; color:#555;">
                        <strong>Filtrar por Oficina:</strong>
                    </div>
                    <input type="text" class="search-box" id="search-0" 
                           placeholder="Ej: ABANCAY">
                    
                    <div style="margin-top:10px;">
                        <button class="btn btn-filtrar" onclick="filtrarCapa(0)" 
                                id="btn-filtrar-0">
                            üîç Aplicar Filtro
                        </button>
                        <button class="btn btn-limpiar" onclick="limpiarFiltro(0)" 
                                id="btn-limpiar-0" style="display:none;">
                            ‚úï Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <div class="capa-item" id="capa-item-1">
                <div style="display:flex; align-items:center; margin-bottom:8px;">
                    <div class="color-box" style="background:#00FF00" 
                         id="color-indicator-1"></div>
                    <label style="flex:1; cursor:pointer; font-weight:bold;">
                        <input type="checkbox" id="toggle-1" checked 
                               onchange="toggleCapa(1)">
                        Zonas
                    </label>
                    <span style="font-size:12px; color:#666; margin-left:10px;">
                        (280)
                    </span>
                    <span class="estado-filtro" id="estado-filtro-1">
                        normal
                    </span>
                </div>
                
                <div class="filtro">
                    <div style="font-size:12px; margin-bottom:5px; color:#555;">
                        <strong>Filtrar por Oficina:</strong>
                    </div>
                    <input type="text" class="search-box" id="search-1" 
                           placeholder="Ej: ABANCAY">
                    
                    <div style="margin-top:10px;">
                        <button class="btn btn-filtrar" onclick="filtrarCapa(1)" 
                                id="btn-filtrar-1">
                            üîç Aplicar Filtro
                        </button>
                        <button class="btn btn-limpiar" onclick="limpiarFiltro(1)" 
                                id="btn-limpiar-1" style="display:none;">
                            ‚úï Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <div class="capa-item" id="capa-item-2">
                <div style="display:flex; align-items:center; margin-bottom:8px;">
                    <div class="color-box" style="background:#0000FF" 
                         id="color-indicator-2"></div>
                    <label style="flex:1; cursor:pointer; font-weight:bold;">
                        <input type="checkbox" id="toggle-2" checked 
                               onchange="toggleCapa(2)">
                        Territorio
                    </label>
                    <span style="font-size:12px; color:#666; margin-left:10px;">
                        (320)
                    </span>
                    <span class="estado-filtro" id="estado-filtro-2">
                        normal
                    </span>
                </div>
                
                <div class="filtro">
                    <div style="font-size:12px; margin-bottom:5px; color:#555;">
                        <strong>Filtrar por Oficina:</strong>
                    </div>
                    <input type="text" class="search-box" id="search-2" 
                           placeholder="Ej: ABANCAY">
                    
                    <div style="margin-top:10px;">
                        <button class="btn btn-filtrar" onclick="filtrarCapa(2)" 
                                id="btn-filtrar-2">
                            üîç Aplicar Filtro
                        </button>
                        <button class="btn btn-limpiar" onclick="limpiarFiltro(2)" 
                                id="btn-limpiar-2" style="display:none;">
                            ‚úï Limpiar
                        </button>
                    </div>
                </div>
            </div>

        </div>
        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <p>üí° <strong>Colores:</strong> Verde (Zonas filtradas) | Azul (Territorio filtrado)</p>
        </div>
    </div>
    
    <!-- Mensaje de carga -->
    <div id="loading">
        <div class="spinner"></div>
        <h3>Cargando mapa...</h3>
        <p id="loading-text">Por favor espera</p>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const capasConfig = [
  {
    "nombre": "Oficina",
    "archivo": "oficina.geojson",
    "elementos": 64,
    "color_normal": "#FF0000",
    "color_filtrado": "#FF6B6B",
    "tipo": "Punto",
    "oficinas": [
      "ABANCAY",
      "ANDAHUAYLAS",
      "AREQUIPA",
      "ATE",
      "AYACUCHO"
    ]
  },
  {
    "nombre": "Zonas",
    "archivo": "zonas.geojson",
    "elementos": 280,
    "color_normal": "#00FF00",
    "color_filtrado": "#00CC00",
    "tipo": "Pol\u00edgono",
    "oficinas": [
      "ABANCAY",
      "ANDAHUAYLAS",
      "AREQUIPA",
      "ATE",
      "AYACUCHO"
    ]
  },
  {
    "nombre": "Territorio",
    "archivo": "territorio.geojson",
    "elementos": 320,
    "color_normal": "#0000FF",
    "color_filtrado": "#0066CC",
    "tipo": "Pol\u00edgono",
    "oficinas": [
      "ABANCAY",
      "ANDAHUAYLAS",
      "AREQUIPA 01",
      "AREQUIPA 02",
      "ATE"
    ]
  }
];
        
        // ============================================
        // VARIABLES
        // ============================================
        const map = L.map('map').setView([-9.19, -75.0], 5);
        const capasLeaflet = {{}};
        const datosOriginales = {{}};
        const filtrosActivos = {{}};
        
        // Capa base
        L.tileLayer('https://{{s}}.tile.openstreetmap.org/{{z}}/{{x}}/{{y}}.png', {{
            attribution: '¬© OpenStreetMap'
        }}).addTo(map);
        
        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        // Cargar una capa desde archivo GeoJSON
        async function cargarCapa(index) {{
            const capaInfo = capasConfig[index];
            
            try {{
                // Cargar desde archivo
                const response = await fetch('data/' + capaInfo.archivo);
                const datos = await response.json();
                
                console.log(`‚úÖ ${{capaInfo.nombre}} cargada: ${{datos.features.length}} elementos`);
                
                // Guardar datos originales
                datosOriginales[index] = datos;
                
                // Crear capa Leaflet con color normal
                capasLeaflet[index] = L.geoJSON(datos, {{
                    style: getEstilo(index, false), // Color normal
                    onEachFeature: function(feature, layer) {{
                        if (feature.properties) {{
                            let contenido = `<div style="max-width:300px;"><h4>${{capaInfo.nombre}}</h4>`;
                            for (let key in feature.properties) {{
                                if (feature.properties[key]) {{
                                    contenido += `<p><b>${{key}}:</b> ${{feature.properties[key]}}</p>`;
                                }}
                            }}
                            contenido += '</div>';
                            layer.bindPopup(contenido);
                        }}
                    }}
                }});
                
                // Agregar al mapa
                capasLeaflet[index].addTo(map);
                
                // Inicializar estado del filtro
                filtrosActivos[index] = false;
                
                return true;
                
            }} catch (error) {{
                console.error(`‚ùå Error cargando ${{capaInfo.nombre}}:`, error);
                return false;
            }}
        }}
        
        // Obtener estilo seg√∫n estado (normal o filtrado)
        function getEstilo(index, esFiltrado) {{
            const capaInfo = capasConfig[index];
            
            if (esFiltrado) {{
                // COLORES PERSONALIZADOS CUANDO EST√Å FILTRADO:
                // - Zonas: Verde (#00CC00)
                // - Territorio: Azul (#0066CC)
                // - Oficina: Rojo claro (#FF6B6B)
                return {{
                    color: capaInfo.color_filtrado,
                    fillColor: capaInfo.color_filtrado,
                    fillOpacity: 0.6,  // M√°s opaco cuando est√° filtrado
                    weight: 3,         // L√≠nea m√°s gruesa
                    opacity: 1.0       // M√°s visible
                }};
            }} else {{
                // Colores normales
                return {{
                    color: capaInfo.color_normal,
                    fillColor: capaInfo.color_normal,
                    fillOpacity: 0.4,
                    weight: 2,
                    opacity: 0.8
                }};
            }}
        }}
        
        // Cargar todas las capas
        async function cargarTodasLasCapas() {{
            let cargadas = 0;
            const total = capasConfig.length;
            
            for (let i = 0; i < total; i++) {{
                const cargado = await cargarCapa(i);
                if (cargado) cargadas++;
                
                // Actualizar texto
                document.getElementById('loading-text').textContent = 
                    `Cargando capas... ${{cargadas}} de ${{total}}`;
            }}
            
            // Ocultar loading
            document.getElementById('loading').style.display = 'none';
            
            // Ajustar vista
            ajustarVista();
            
            console.log(`‚úÖ Todas las capas cargadas: ${{cargadas}}/${{total}}`);
        }}
        
        // Mostrar/ocultar capa
        function toggleCapa(index) {{
            const checkbox = document.getElementById('toggle-' + index);
            if (capasLeaflet[index]) {{
                if (checkbox.checked) {{
                    map.addLayer(capasLeaflet[index]);
                }} else {{
                    map.removeLayer(capasLeaflet[index]);
                }}
            }}
        }}
        
        // Filtrar por oficina
        async function filtrarCapa(index) {{
            const searchBox = document.getElementById('search-' + index);
            const termino = searchBox.value.toLowerCase().trim();
            
            if (!termino) {{
                alert('Por favor, escribe una oficina para filtrar');
                return;
            }}
            
            if (!datosOriginales[index]) {{
                alert('Los datos no est√°n cargados');
                return;
            }}
            
            // Mostrar indicador de procesamiento
            const btnFiltrar = document.getElementById('btn-filtrar-' + index);
            const originalText = btnFiltrar.innerHTML;
            btnFiltrar.innerHTML = '‚è≥ Procesando...';
            btnFiltrar.disabled = true;
            
            // Filtrar features (hacerlo as√≠ncrono para no bloquear la UI)
            setTimeout(() => {{
                const featuresFiltradas = datosOriginales[index].features.filter(feature => {{
                    if (!feature.properties) return false;
                    
                    // Buscar campo OFICINA (case insensitive)
                    for (let key in feature.properties) {{
                        if (key.toUpperCase().includes('OFICINA')) {{
                            const valor = String(feature.properties[key]).toLowerCase();
                            return valor.includes(termino);
                        }}
                    }}
                    return false;
                }});
                
                console.log(`üîç Filtro aplicado a ${{capasConfig[index].nombre}}: "${{termino}}"`);
                console.log(`üìä Resultados: ${{featuresFiltradas.length}} de ${{datosOriginales[index].features.length}}`);
                
                if (featuresFiltradas.length === 0) {{
                    alert('‚ùå No se encontraron resultados para: "' + termino + '"');
                    btnFiltrar.innerHTML = originalText;
                    btnFiltrar.disabled = false;
                    return;
                }}
                
                // Crear nuevos datos filtrados
                const datosFiltrados = {{
                    type: 'FeatureCollection',
                    features: featuresFiltradas
                }};
                
                // Remover capa actual del mapa
                if (capasLeaflet[index]) {{
                    map.removeLayer(capasLeaflet[index]);
                }}
                
                // Crear nueva capa filtrada con COLOR PERSONALIZADO
                capasLeaflet[index] = L.geoJSON(datosFiltrados, {{
                    style: getEstilo(index, true), // Usar color de filtrado
                    onEachFeature: function(feature, layer) {{
                        if (feature.properties) {{
                            let contenido = `<div style="max-width:300px;">
                                <h4 style="color:${{capasConfig[index].color_filtrado}};">
                                    ${{capasConfig[index].nombre}} (Filtrado)
                                </h4>`;
                            for (let key in feature.properties) {{
                                if (feature.properties[key]) {{
                                    contenido += `<p><b>${{key}}:</b> ${{feature.properties[key]}}</p>`;
                                }}
                            }}
                            contenido += '</div>';
                            layer.bindPopup(contenido);
                        }}
                    }}
                }});
                
                // Agregar al mapa si est√° activa
                const checkbox = document.getElementById('toggle-' + index);
                if (checkbox && checkbox.checked) {{
                    capasLeaflet[index].addTo(map);
                }}
                
                // Actualizar interfaz
                filtrosActivos[index] = true;
                
                // Cambiar colores en la UI
                document.getElementById('color-indicator-' + index).style.background = 
                    capasConfig[index].color_filtrado;
                document.getElementById('estado-filtro-' + index).textContent = 'filtrado';
                document.getElementById('estado-filtro-' + index).className = 'estado-filtro activo';
                document.getElementById('capa-item-' + index).className = 'capa-item filtrada';
                
                // Mostrar/ocultar botones
                document.getElementById('btn-filtrar-' + index).style.display = 'none';
                document.getElementById('btn-limpiar-' + index).style.display = 'inline-block';
                
                // Restaurar bot√≥n
                btnFiltrar.innerHTML = originalText;
                btnFiltrar.disabled = false;
                
                // Ajustar vista a los resultados filtrados
                ajustarVistaCapa(index);
                
                // Mostrar mensaje de √©xito
                alert(`‚úÖ Filtro aplicado a ${{capasConfig[index].nombre}}
` +
                      `üìä Encontrados: ${{featuresFiltradas.length}} elementos`);
                
            }}, 100); // Peque√±o delay para mejor UX
        }}
        
        // Limpiar filtro
        function limpiarFiltro(index) {{
            // Limpiar campo de b√∫squeda
            document.getElementById('search-' + index).value = '';
            
            // Restaurar datos originales
            if (!datosOriginales[index]) return;
            
            // Remover capa actual
            if (capasLeaflet[index]) {{
                map.removeLayer(capasLeaflet[index]);
            }}
            
            // Crear nueva capa con datos originales y color normal
            capasLeaflet[index] = L.geoJSON(datosOriginales[index], {{
                style: getEstilo(index, false), // Color normal
                onEachFeature: function(feature, layer) {{
                    if (feature.properties) {{
                        let contenido = `<div style="max-width:300px;"><h4>${{capasConfig[index].nombre}}</h4>`;
                        for (let key in feature.properties) {{
                            if (feature.properties[key]) {{
                                contenido += `<p><b>${{key}}:</b> ${{feature.properties[key]}}</p>`;
                            }}
                        }}
                        contenido += '</div>';
                        layer.bindPopup(contenido);
                    }}
                }}
            }});
            
            // Agregar al mapa si est√° activa
            const checkbox = document.getElementById('toggle-' + index);
            if (checkbox && checkbox.checked) {{
                capasLeaflet[index].addTo(map);
            }}
            
            // Actualizar interfaz
            filtrosActivos[index] = false;
            
            // Restaurar colores en la UI
            document.getElementById('color-indicator-' + index).style.background = 
                capasConfig[index].color_normal;
            document.getElementById('estado-filtro-' + index).textContent = 'normal';
            document.getElementById('estado-filtro-' + index).className = 'estado-filtro';
            document.getElementById('capa-item-' + index).className = 'capa-item';
            
            // Mostrar/ocultar botones
            document.getElementById('btn-filtrar-' + index).style.display = 'inline-block';
            document.getElementById('btn-limpiar-' + index).style.display = 'none';
            
            // Ajustar vista
            ajustarVista();
            
            console.log(`üîÑ Filtro limpiado: ${{capasConfig[index].nombre}}`);
        }}
        
        // Ajustar vista a todas las capas
        function ajustarVista() {{
            setTimeout(() => {{
                let bounds = null;
                
                for (let index in capasLeaflet) {{
                    const capa = capasLeaflet[index];
                    const checkbox = document.getElementById('toggle-' + index);
                    
                    if (capa && checkbox && checkbox.checked && capa.getBounds) {{
                        if (!bounds) {{
                            bounds = capa.getBounds();
                        }} else {{
                            bounds.extend(capa.getBounds());
                        }}
                    }}
                }}
                
                if (bounds && bounds.isValid()) {{
                    map.fitBounds(bounds, {{ padding: [50, 50] }});
                }}
            }}, 500);
        }}
        
        // Ajustar vista a una capa espec√≠fica
        function ajustarVistaCapa(index) {{
            const capa = capasLeaflet[index];
            if (capa && capa.getBounds) {{
                const bounds = capa.getBounds();
                if (bounds.isValid()) {{
                    map.fitBounds(bounds, {{ padding: [50, 50] }});
                }}
            }}
        }}
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {{
            console.log("üöÄ Inicializando mapa con filtros...");
            console.log("Configuraci√≥n de colores:");
            capasConfig.forEach((capa, i) => {{
                console.log(`  ${{capa.nombre}}: Normal=${{capa.color_normal}}, Filtrado=${{capa.color_filtrado}}`);
            }});
            cargarTodasLasCapas();
        }});
        
    </script>
</body>
</html>